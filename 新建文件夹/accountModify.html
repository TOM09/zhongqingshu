<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
    <title>账号设置</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
<meta name="toTop" content="true">
<%@ include file="messageCount.jsp" %>
<link href="/static/css/base.css" rel="stylesheet" type="text/css" />
<!--bootstrap框架↓-->
<link href="/static/bootstrap-3.3.7-dist/css/bootstrap.css" rel="stylesheet" type="text/css" />
<link href="/static/bootstrap-3.3.7-dist/css/bootstrap-theme.css" rel="stylesheet" type="text/css" />
<!--本页面CSS↓-->
<link rel="stylesheet" href="/static/css/swiper.css">
<link rel="stylesheet" href="/static/css/style.css">
<!--bootstrap框架↓-->
<script type="text/javascript" src="/static/js/jquery-3.1.1.js"></script>
<script type="text/javascript" src="/static/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/static/bootstrap-3.3.7-dist/js/bootstrap.js"></script>
<script type="text/javascript" src="/static/js/jquery.tabslet.min.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/util.js"></script>
    <style>
        input::-ms-clear,input::-ms-reveal{display:none;}
    </style>
</head>
<body>
<!--头部开始-->
<jsp:include page="toppage.jsp"></jsp:include>
<div class="Header">
    <dl class="Login_topdl">
		<dt style="margin-top:9px;"><img src="../../../static/images/logo.png" style="width:111px;height:43px;"></dt>
        <dd class="nav" style="padding-left:20px;"><a href="/mcbn/services/dispense/approveSuccess">首页</a><a href="/mcbn/services/resume/pushResume">招聘</a><a href="/mcbn/services/publicgood/query">公益</a><a href="/mcbn/services/train/train">培训</a><a href="/mcbn/services/policy/policy">政策</a><a href="">APP</a></dd>
	</dl>
</div>
<!--头部end-->
<div class="w1200">
<div class="main_fff mar_box">
    <dl class="Login_tit">
		<dt>账号设置</dt>
	</dl>
    
    <div class="person04_box">
    	<div class="person_list">
        	<div class="person_list_name">
            	用户名：
            </div>
            <div class="person_list_box">
            	<div class="person_gerena">
                	<span id="oldName" style="width: 160px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;"></span>
                    <a href="javascript:void(0);" class="open_tca">修改</a>
                </div>
            </div>
        </div>
        
        <div class="person_list">
        	<div class="person_list_name">
            	绑定手机号：
            </div>
            <div class="person_list_box">
            	<div class="person_gerena">
                    <input type="hidden" id="oldPhoner"/>
                	<span id="oldPhone">138****6128</span>
                    <a href="javascript:void(0);" class="open_tcb">修改</a>
                </div>
            </div>
        </div>
        
        <div class="person_list">
        	<div class="person_list_name">
            	登录密码：
            </div>
            <div class="person_list_box">
            	<div class="person_gerena">
                    <span id="oldPw">*********</span>
                    <a href="javascript:void(0);" class="open_tcd">修改</a>
                </div>
            </div>
        </div>
        
        
    </div>
	
	
</div>
</div>	
<!--尾部开始-->
<div class="footer">
<jsp:include page="footerpage.jsp"></jsp:include>
</div>

<div class="tc_box2">
	<div class="tc_box_con" style="height: 550px;">
    	<div class="close_tc">
    		<img src="/static/images/Group 2.png"/>
    	</div>
    	<div class="tc_box_contitle">
        	修改手机号
        </div>
        <div class="tc_box_tablelist">
            <div class="tc_box_tablelistname">
                原手机号：
            </div>
            <div class="tc_box_tablelistinput">
                <input class="tc_ipnuts inp" id="yinputPhoneNumber"/>
            </div>
        </div>
        <div class="tc_box_tablelist">
            <div class="tc_box_tablelistname">
                验证码：
            </div>
            <div class="tc_box_tablelistinput">
                <input class="tc_ipnutsa inp" id="yinputPhoneVerifyCode"/>
                <button id="ybuttonGetPhoneVerifyCode" class="code_input" onclick="getYPhoneVerifyCode()">获取验证码</button>
            </div>
        </div>
        <div class="tc_box_tablelist">
        	<div class="tc_box_tablelistname">
            	新手机号：
            </div>
            <div class="tc_box_tablelistinput">
            	<input class="tc_ipnuts inp" id="inputPhoneNumber"/>
            </div>
        </div>
        <div class="tc_box_tablelist">
        	<div class="tc_box_tablelistname">
            	验证码：
            </div>
            <div class="tc_box_tablelistinput">
            	<input class="tc_ipnutsa inp" id="inputPhoneVerifyCode"/>
                <button id="buttonGetPhoneVerifyCode" class="code_input" onclick="getPhoneVerifyCode()">获取验证码</button>
            </div>
        </div>
        <span id="newphonetitle" class="redfont" style="display: block;height: 30px;text-align: center;"></span>
		<button class="tc_btn" onclick="modifyPhone()" >完成</button>
    </div>
</div>
	
<div class="tc_box4">
	<div class="tc_box_con3">
    	<div class="close_tc">
    		<img src="/static/images/Group 2.png"/>
    	</div>
    	<div class="tc_box_contitle">
        	修改登录密码
        </div>
        <div class="tc_box_tablelist">
        	<div class="tc_box_tablelistname">
            	原密码：
            </div>
            <div class="tc_box_tablelistinput">
            	<input class="login_pawd2 inp" type="password" id="mOldPassWord"  style="height: 45px;"/><a id="xs1" href="javascript:void(0);" style="margin-left: 287px;height: 42px;display: block;position: relative;width: 36px;"></a>
            </div>
        </div>
        <div class="tc_box_tablelist">
        	<div class="tc_box_tablelistname" >
            	新密码：
            </div>
            <div class="tc_box_tablelistinput">
            	<input class="login_pawd2 inp" type="password" id="mNewPassWord1" style="height: 45px;" /><a id="xs2" href="javascript:void(0);" style="margin-left: 287px;height: 42px;display: block;position: relative;width: 36px;"></a>
            </div>
        </div>
        <div class="tc_box_tablelists">
        	<div class="tc_box_tablelistname">
            	&nbsp;
            </div>
            <div class="tc_box_tablelistinputsa">
            	字母数字混合，8位以上20位以下
            </div>
        </div>
        
        
        <div class="tc_box_tablelist">
        	<div class="tc_box_tablelistname">
            	确认密码：
            </div>
            <div class="tc_box_tablelistinput">
            	<input class="login_pawd2 inp" type="password" id="mNewPassWord2"  style="height: 45px;"/><a id="xs3" href="javascript:void(0);" style="margin-left: 287px;height: 42px;display: block;position: relative;width: 36px;"></a>
            </div>
        </div>
        <div class="tc_box_tablelists">
        	<div class="tc_box_tablelistname">
            	&nbsp;
            </div>
            <div class="tc_box_tablelistinputsa">
            	字母数字混合，8位以上20位以下
            </div>
        </div>
        <span id="newpwtitle" class="redfont" style="display: block;height: 30px;text-align: center;"></span>
		<button class="tc_btn" style="margin-top:30px;" onclick="modeifyPassWord()">完成</button>
    </div>
</div>

<div class="tc_box" id="tc1">
    <div class="tc_box_con">
        <div class="close_tc">
            <img src="/static/images/Group 2.png"/>
        </div>
        <div class="tc_box_contitle">
            修改用户名
        </div>
        <div class="tc_box_tablelist">
            <div class="tc_box_tablelistname">
                新用户名：
            </div>
            <div class="tc_box_tablelistinput">
                <input class="tc_ipnuts inp" id="newUserName"/>
                <span id="newusernametitle" class="redfont" style="display: block;height: 30px;"></span>
            </div>

        </div>
        <button class="tc_btn" onclick="modifyUserName()" >完成</button>
    </div>
</div>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 300px;">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
            </div>
            <div class="modal-body" id="prompt">

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">确定
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    $("#xs1").click(function () {
        if ($("#mOldPassWord").attr("type") == "password") {
            $("#mOldPassWord").attr("type","text");
        }else {
            $("#mOldPassWord").attr("type","password");
        }
    });
    $("#xs2").click(function () {
        if ($("#mNewPassWord1").attr("type") == "password") {
            $("#mNewPassWord1").attr("type","text");
        }else {
            $("#mNewPassWord1").attr("type","password");
        }
    });
    $("#xs3").click(function () {
        if ($("#mNewPassWord2").attr("type") == "password") {
            $("#mNewPassWord2").attr("type","text");
        }else {
            $("#mNewPassWord2").attr("type","password");
        }
    });
    var userId = "${userId}";
	$('.open_tca').click(function(){
		$('#tc1').show();
		});
	$('.close_tc').click(function(){
		$('.tc_box').hide();
        $('#tc1').hide();
        $('.tc_box2').hide();
        $('.tc_box3').hide();
        $('.tc_box4').hide();
        $('.inp').val("");
		});

	$('.open_tcb').click(function(){
		$('.tc_box2').show();
		});
	$('.open_tcc').click(function(){
		$('.tc_box3').show();
		});
	$('.open_tcd').click(function(){
		$('.tc_box4').show();
		});
    $('#buttonGetPhoneVerifyCode').click(function(){
        $('.tc_box4').hide();
    });
    function getPhoneVerifyCode(){
        $("#newphonetitle").html("");
        var phonenumber = $("#inputPhoneNumber").val();
        if(phonenumber != "" && phonenumber != null) {
            var ydata = {};
            ydata.mobilePhone = phonenumber;
            ydata.clientType = 102500;
            ajax("${servicefix}/services/user/check/available/mobile", ydata, function (result) {
                if(!result.datas[0]){
                    $("#newphonetitle").html("新手机号已注册");
                } else {
                    var data = {};
                    data.mobilePhoneNumber = phonenumber;
                    data.clientType = 102500;
                    ajax("${servicefix}/services/user/security/code/mobile", data, function (result) {});
                }
            });
        } else {
            $("#newphonetitle").html("请输入手机号");
        }
    }

    function getYPhoneVerifyCode(){
        $("#newphonetitle").html("");
        var phonenumber = $("#yinputPhoneNumber").val();
        if(phonenumber != "" && phonenumber != null) {
                var ryphonenumber = $("#oldPhoner").val();
                if(ryphonenumber != phonenumber){
                    $("#newphonetitle").html("请输入正确的原手机号");
                } else {
                    var data = {};
                    data.mobilePhoneNumber = phonenumber;
                    data.clientType = 102500;
                    ajax("${servicefix}/services/user/security/code/mobile", data, function (result) {});
                }
        } else {
            $("#newphonetitle").html("请输入原手机号");
        }
    }

    function modifyPhone(){
        $("#newphonetitle").html('');
        var phonenumber = $("#inputPhoneNumber").val();
        var verifyCode = $("#inputPhoneVerifyCode").val();
        var oldphonenumber = $("#yinputPhoneNumber").val();
        var oldverifyCode = $("#yinputPhoneVerifyCode").val();
        if(oldphonenumber == ""){
            $("#newphonetitle").html('请输入原手机号');
        } else if(oldphonenumber != $("#oldPhoner").val()){
            $("#newphonetitle").html('请输入正确的原手机号');
        } else if(oldverifyCode == ""){
            $("#newphonetitle").html('请输入原手机号验证码');
        } else if(phonenumber == ""){
            $("#newphonetitle").html('请输入新手机号');
        } else if(verifyCode == ""){
            $("#newphonetitle").html('请输入新手机号验证码');
        } else{
            var data = {};
            data.userId = Number(userId);
            data.oldMobile = oldphonenumber;
            data.newMobile = phonenumber;
            data.newMobileSecurityCode = verifyCode;
            data.oldMobileSecurityCode = oldverifyCode;
            data.clientType = 102500;
            ajax("${servicefix}/services/user/mobile/change",data,function (result) {
                var resultCode = result.resultCode;
                if(resultCode == "1") {
                    $('.tc_box2').hide();
                    $('.inp').val("");
                    query();
                } else if(result.errorMessage=="Old mobile security code don't match."){
                    $("#newphonetitle").html("原手机号验证码错误");
                } else if(result.errorMessage=="New mobile security code don't match."){
                    $("#newphonetitle").html("验证码错误");
                } else if(result.errorMessage=="Register company failed."){
                    $("#newphonetitle").html("新手机号已注册");
                }  else {
                    $("#newphonetitle").html('修改失败');
                }
            });
        }
    }

    function modeifyPassWord(){
        $("#newpwtitle").html("");
        var mOldPassWord = $("#mOldPassWord").val();
        var mNewPassWord1 = $("#mNewPassWord1").val();
        var mNewPassWord2 = $("#mNewPassWord2").val();
        if(mOldPassWord == ""){
            $("#newpwtitle").html("请输入原密码");
        } else if(mNewPassWord1 == ""){
            $("#newpwtitle").html("请输入新密码");
        } else if(mNewPassWord2 == ""){
            $("#newpwtitle").html("请输入确认密码");
        } else if(mNewPassWord2 != mNewPassWord1){
            $("#newpwtitle").html("密码与确认密码不一致");
        } else  if(!/^(?![0-9]+$)(?![a-zA-Z]+$)[0-9A-Za-z]{8,20}$/.test(mNewPassWord1)){
            $("#newpwtitle").html("密码须字母数字混合，8位以上20位以下");
        } else {
            var data = {};
            data.userId = userId;
            data.oldPassword = mOldPassWord;
            data.newPassword = mNewPassWord1;
            data.clientType = 102500;
            ajax("${servicefix}/services/user/password/change",data,function (result) {
                var resultCode = result.resultCode;
                if(resultCode == "1") {
                    $('.tc_box4').hide();
                    $('.inp').val("");
                    query();
                } else {
                    if(result.errorMessage=="Validate old password failed."){
                        $("#newpwtitle").html("原密码错误");
                    } else if(result.errorMessage=="authentication_failed"){
                        $("#newpwtitle").html("请重新登陆");
                    } else {
                        $("#newpwtitle").html("修改失败");
                    }
                }
            });
        }
    }
    function modifyUserName(){
        $("#newusernametitle").html("");
        var oldnm = $("#oldName").html();
        var newnm = $("#newUserName").val();
        if(newnm == ""){
            $('#prompt').html('请输入用户名');
            $('#myModal').modal('show');
        }  else{
            var data = {};
            data.companyId = Number("${companyId}");
            data.oldNickname = oldnm;
            data.newNickname = newnm;
            data.clientType = 102500;
            ajax("${servicefix}/services/company/nickname/change",data,function (result) {
                var resultCode = result.resultCode;
                if(resultCode == "1") {
                    $('#tc1').hide();
                    $('.inp').val("");
                    $.cookie('userName', newnm, { path: '/', expires: 100 });
                    $("#lusername").html(newnm+"<b></b>");
                    query();
                } else {
                    if(result.errorMessage=="authentication_failed"){
                        $("#newusernametitle").html("请重新登陆");
                    } else {
                        $("#newusernametitle").html("新用户名已存在");
                    }
                }
            });
        }
    }
    function query(){
        var data = {};
        data.id = "${userId}";
        ajax("/mcbn/services/user/detail", data, function (result) {
            var userinfo = result.datas[0];
            var resultCode = result.resultCode;
            if (resultCode=="1" && userinfo != null) {
                $("#oldName").html(userinfo.name);
                $("#oldName").attr("title",userinfo.name);
                $("#oldPhoner").val(userinfo.mobilePhone);
                $("#oldPhone").html(userinfo.mobilePhone.substr(0, 3) + '****' + userinfo.mobilePhone.substr(7));
            }
        })
    }
    $(document).ready(function() {
        $("#lusername").html($.cookie('userName')+"<b></b>");
        query();
    })
</script>
</body>
</html>